{% extends "login_base.html" %}
{% block content %}
<div style="padding:80px 0;">
<script type="text/javascript">
	function create_Tree(data){
		var dataTree = data['body'];
		var head = dataTree['head'];

		//Format html to theme
		document.write('<div class="list-group"><div class="list-group-item active" id="title">'+data['title']+'</div>')

		//Create tree
		document.write('<div class="tree list-group-item" id="chart">');
		document.write("<p id='treatment_id' class='hidden'>"+data['id']+"<p>");

		// Head id
		document.write("<ul id = 'root'><li id="+head+"><p>");

		//Grabbing children from head and creating tree
		var childrens = dataTree[head]['children'];
		children(dataTree,head);
		document.write("</p></li></ul>");

		//Creating save button
		var save_button =document.createElement("INPUT");
		save_button.type = "button";
		save_button.onclick = function(){save()};
		save_button.value = "Save";
		document.write("</div>");
		document.getElementById("chart").appendChild(save_button);
		document.write('</div>');
	}

	// Function to recrusively create tree from json file
	function children(data,head){
		//Child info
		var childrens = data[head]['children'];
		document.write("<p id='"+head+"_Description'>"+data[head]['description']+"</p>");
		document.write("<p id='"+head+"_Wait' class='hidden'>"+data[head]['wait']+"</p>");
		document.write("<p id='"+head+"_Icon' class='hidden'>"+data[head]['icon']+"</p>");

		//Buttons
		document.write("<input type=button id="+head+"_Add"+ " class ='btn btn-primary btn-xs' value='+' onclick=add('"+head+"')></input>")
		document.write("<input type=button id="+head+"_Delete"+ " class ='btn btn-danger btn-xs' value='x' onclick=removeBranch('"+head+"')></input>")

		//Create childrens
		if (childrens.length>0){
			document.write("<ul id = "+head+"_Children>");
			for(var i =0;i<childrens.length;i++){
				// Display child id (Probably need to change css if you want to change way this is implemented)
				document.write("<li id = "+ childrens[i]+"><p class='un-hidden'>" + childrens[i]);
				children(data, childrens[i]);
				document.write("</p></li>")
			}

			document.write("</ul>");
		}
	}

	// Function to add child
	//TODO: Clean up and add other buttons and change implementation
	function add(head){
		var child_id=gen_uuid();
		var child = document.createElement("LI");
		child.id = child_id+"_Temp_Field";
		var child_field=document.createElement("INPUT");
		child_field.type="text";
		child_field.id=child_id+"_Description";
		child_field.placeholder="Description";
		child.appendChild(child_field);

		var submit_form = document.createElement("FORM");
		submit_form.action="";
		submit_form.method="POST";

		var submit_button = document.createElement("INPUT");
		submit_button.value = "submit";
		submit_button.type = "button";
		submit_button.id = child_id+"_Submit";
		submit_button.onclick=function(){addNode(head,child_id)};
		child.appendChild(submit_button);
		var have_children = document.getElementById(head+"_Children");
		if(!have_children){
			var child_list = document.createElement("UL");
			child_list.id = head+"_Children";
			document.getElementById(head).appendChild(child_list);
			have_children = document.getElementById(head+"_Children");
		}
		have_children.appendChild(child);
	}

	// Add's child to html
	function addNode(head,child_id){
		descript_loc =document.getElementById(child_id+"_Description");
		descript = descript_loc.value;
		if(descript){
			document.getElementById(head+"_Children").removeChild(document.getElementById(child_id+"_Temp_Field"));
			var create_child = document.createElement("LI");
			create_child.id = child_id;
			var id_text = document.createTextNode(child_id);
			var descript_text = document.creaateTextNode(descript);
			create_child.appendChild(id_text);

			var break_element = document.createElement("br");
			create_child.appendChild(break_element);
			create_child.appendChild(descript_text);
			var break_element = document.createElement("br");
			create_child.appendChild(break_element);

			add_button = document.createElement("INPUT");
			add_button.type = "button";
			add_button.id = child_id+"_Add";
			add_button.value = "Add";
			add_button.class = resize_button;
			add_button.onclick = function(){add(child_id)};
			create_child.appendChild(add_button);
			document.getElementById(head+"_Children").appendChild(create_child);
		}
	}

	//Remove child (delete) and branch
	function removeBranch(head){
			var child_element = document.getElementById(head);
			var element_to_remove = child_element.parentNode; // list of all children's (if not root)
			if(element_to_remove.childNodes.length>1){
				element_to_remove=child_element;
				var confirmed = confirm("Are you sure you want to delete this entire branch?");
				if(confirmed==false){
					return;
				}
			}
			var parent_node = element_to_remove.parentNode;
			var parent_name = parent_node.nodeName;
			if(parent_name=="LI" || parent_name =="UL"){
				var parent_id = parent_node.id;
				var parent_element = document.getElementById(parent_id);
				console.log(parent_id);
				parent_element.removeChild(element_to_remove);
			}else{ //Clear tree besides head
				confirm("Are you sure you want to clear the entire chart?");
				var child_id = child_element.id;
				element_to_remove = document.getElementById(child_id+"_Children");
				child_element.removeChild(element_to_remove);
			}
	}

	// Post mes
	function save(){
		var id = document.getElementById("treatment_id").innerHTML;
		var json = {};
		var head_id = document.getElementById("root").firstChild.id;
		json['id']=document.getElementById("treatment_id").innerHTML;
		json['title']= document.getElementById("title").innerHTML;
		json['body'] = translate_json(head_id);
		console.log(json)
		var treatment_plan_text =JSON.stringify(json)
		var send_req = new XMLHttpRequest();
		send_req.open("POST","http://localhost:5000/treatment_plans/"+id, true);
		send_req.setRequestHeader('Content-Type','application/json; charset=UTF-8');
		send_req.send(treatment_plan_text);
		send_req.onloadend=function(){
			if(send_req.status == 200){
				alert("Successfully saved");
			}else{
				alert("We have a problem...Don't know why but WE HAVE A PROBLEM");
			}
		}
	}

	//Online source
	function gen_uuid() {
    	return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    	    var r = Math.random()*16|0, v = c === 'x' ? r : (r&0x3|0x8);
        	return v.toString(16);
    	});
	}

	function translate_json(head_id){
		body = {};
		body['head']=head_id;
		var temp_json={};
		temp_json['wait']=document.getElementById(head_id+"_Wait").innerHTML;
		temp_json['description']=document.getElementById(head_id+"_Description").innerHTML;
		temp_json['icon']=document.getElementById(head_id+"_Icon").innerHTML;
		var children_array = [];
		if(document.getElementById(head_id+"_Children")){
			var child_nodes = document.getElementById(head_id+"_Children").childNodes;
			var i;
			for(i=0; i<child_nodes.length;i++){
				children_array.push(child_nodes[i].id);
				translate_child(child_nodes[i].id);
			}
			temp_json['children']=children_array;
		}
		body[head_id]=temp_json;
		return body;
	}

	function translate_child(head_id){
		var temp_json = {};
		temp_json['wait']=document.getElementById(head_id+"_Wait").innerHTML;
		temp_json['description']=document.getElementById(head_id+"_Description").innerHTML;
		temp_json['icon']=document.getElementById(head_id+"_Icon").innerHTML;
		var children_array = [];
		if(document.getElementById(head_id+"_Children")) {
			var child_nodes = document.getElementById(head_id+"_Children").childNodes;
			var i;
			for(i=0; i<child_nodes.length;i++){
				children_array.push(child_nodes[i].id);
				translate_child(child_nodes[i].id);
			}
		}
		temp_json['children']=children_array;
		body[head_id]=temp_json
	}
	create_Tree({{data|safe}});
</script>
<div id="add_child_modal" class="modal">
	<div class="modal-content">
		<span class="close">x</span>
		<p>Some text in the Modal..</p>
	</div>
</div>
{%endblock%}